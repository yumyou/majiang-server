<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yanzu.module.member.dal.mysql.couponinfo.CouponInfoMapper">
    <update id="executeCouponExpire">
        update member_coupon_info
        set status=2
        where deleted = 0
          and status = 0
          and exprice_time &lt; now()
    </update>

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->

    <select id="countByUserId" resultType="java.lang.Integer">
        select count(1)
        from member_coupon_info
        where user_id = #{userId}
          and status = 0
          ANd deleted = 0
    </select>
    <select id="getCouponPage" resultType="com.yanzu.module.member.controller.app.user.vo.AppCouponPageRespVO">
        SELECT
        c.*,o.order_id,s.store_name
        FROM
        member_coupon_info c
        left join member_store_info s ON s.store_id=c.store_id
        left join member_order_info o ON o.coupon_id=c.coupon_id  and o.status!=3
        WHERE
        c.deleted =0 and c.user_id=#{reqVO.userId}
        <if test="null != reqVO.status">
            and c.status=#{reqVO.status}
        </if>
        ORDER BY c.exprice_time ASC
    </select>
    <select id="getByUserIdAndCouponId"
            resultType="com.yanzu.module.member.dal.dataobject.couponinfo.CouponInfoDO">
        select *
        from member_coupon_info
        where deleted = 0
          and user_id = #{userId}
          and coupon_id = #{couponId}

    </select>
    <select id="getCouponPageByAdmin"
            resultType="com.yanzu.module.member.controller.app.user.vo.AppCouponPageRespVO">
        SELECT
        c.*,s.store_name
        FROM
        member_coupon_info c
        left join member_store_info s ON s.store_id=c.store_id
        WHERE
        c.deleted =0 and c.user_id is null
        and c.store_id IN (${storeIds})
        <if test="null != reqVO">
            <if test="null != reqVO.type and reqVO.type != ''">
                and c.type=#{reqVO.type}
            </if>
            <if test="null != reqVO.storeId and reqVO.storeId != ''">
                and c.store_id=#{reqVO.storeId}
            </if>
        </if>
        order by c.create_time desc
    </select>
    <select id="getCouponDetail"
            resultType="com.yanzu.module.member.controller.app.manager.vo.AppCouponDetailRespVO">
        SELECT c.*, s.store_name
        FROM member_coupon_info c
                 left join member_store_info s ON c.store_id = s.store_id
        WHERE c.deleted = 0
          and c.coupon_id = #{couponId}

    </select>
    <select id="getByIdAndAdmin" resultType="com.yanzu.module.member.dal.dataobject.couponinfo.CouponInfoDO">
        select * from member_coupon_info where deleted=0 and user_id is null and exprice_time>now() and coupon_id=#{couponId}
    </select>

    <select id="countNewUserByStoreId" resultType="java.lang.Integer">
        SELECT count(1)
        from member_coupon_info
        where deleted = 0
          and user_id = #{userId}
          and store_id = #{storeId}
          and coupon_name = '新用户1小时加时券'
    </select>
</mapper>
